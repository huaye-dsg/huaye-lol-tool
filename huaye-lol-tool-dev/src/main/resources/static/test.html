<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏助手配置面板</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./toastify.min.css">
    <style>
        /* CSS */
        body { background-color: #f8f9fa; padding-top: 2rem; padding-bottom: 2rem; }
        #app { max-width: 2000px; width: 90vw; margin: auto; background: #ffffff; padding: 2rem; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .section-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; }
        .form-check-label { cursor: pointer; }
        .table-container { margin-top: 1.5rem; }
        .btn-query { margin-bottom: 1rem; }
        .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
        .config-container { display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; padding: 0.5rem 0; }
        .searchable-select-container { position: relative; min-width: 220px; transition: all 0.3s ease-in-out; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; background-color: #fff; border: 1px solid #ced4da; border-radius: 0.375rem; box-shadow: 0 .5rem 1rem rgba(0,0,0,.15); list-style: none; padding: 0; margin-top: 0.25rem; }
        .search-results li { padding: 0.5rem 1rem; cursor: pointer; transition: background-color 0.2s; }
        .search-results li:hover { background-color: #e9ecef; }
        .search-results .hero-details { font-size: 0.8em; color: #6c757d; margin-left: 8px; }

        /* --- KDA 样式 --- */
        .kda-win { background-color: rgba(39, 217, 71, 0.8) !important; color: #0f5132; }
        .kda-loss { background-color: rgba(239, 65, 81, 0.89) !important; color: #e73e4b; }

        /* --- 新增样式 --- */
        .btn-reconnect { display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1 class="mb-4 text-center">游戏助手配置面板</h1>

    <!-- ======================= 配置部分 (重连按钮已移动) ======================= -->
    <section>
        <div class="section-header d-flex justify-content-between align-items-center">
            <h2 class="h4 mb-0">功能配置</h2>
            <!-- 重连按钮新位置 -->
            <button class="btn btn-outline-secondary btn-reconnect" @click="handleReconnect">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
                重连
            </button>
        </div>
        <div class="config-container">
            <!-- 开关1: 自动接受游戏 -->
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" role="switch" id="autoAcceptSwitch" v-model="config.autoAcceptGame" @change="handleAutoAcceptChange">
                <label class="form-check-label" for="autoAcceptSwitch">自动接受游戏</label>
            </div>

            <!-- 开关2: 自动禁用英雄 -->
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" role="switch" id="autoBanSwitch" v-model="config.autoBanChamp" @change="onBanSwitchChange">
                <label class="form-check-label" for="autoBanSwitch">自动禁用英雄</label>
            </div>

            <!-- 可搜索下拉框 -->
            <div class="searchable-select-container" v-if="config.autoBanChamp">
                <input
                        type="text"
                        class="form-control"
                        v-model="searchQuery"
                        :placeholder="selectedHeroDisplayName || '-- 搜索英雄名/昵称/ID --'"
                        @focus="isDropdownVisible = true"
                        @blur="hideDropdown"
                        autocomplete="off">
                <ul class="search-results" v-if="isDropdownVisible && filteredHeroes.length > 0">
                    <li v-for="hero in filteredHeroes" :key="hero.id" @mousedown="selectHero(hero)">
                        {{ hero.name }} <span class="hero-details"> ({{ hero.nickname }}, ID: {{ hero.id }})</span>
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <hr class="my-4">

    <!-- ======================= 对局详情查询 ======================= -->
    <section>
        <div class="section-header">
            <h2 class="h4 mb-0">对局详情查询</h2>
        </div>
        <div class="row g-4">
            <!-- 我方队友 -->
            <div class="col-lg-6 table-container">
                <h3 class="h5">我方队友</h3>
                <button class="btn btn-primary btn-query" @click="fetchTableData(1)">查询我方战绩</button>
                <table class="table table-hover table-bordered table-sm">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th><th scope="col">马匹</th><th scope="col">分数</th><th scope="col">段位</th><th scope="col">名字</th><th scope="col" colspan="5">最近5场战绩</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-if="tables.table1.data.length === 0"><td colspan="10" class="text-center text-muted">请点击查询按钮加载数据</td></tr>
                    <tr v-for="(item, index) in tables.table1.data" :key="index">
                        <th scope="row">{{ index + 1 }}</th><td>{{ item.horse }}</td><td>{{ item.score }}</td><td>{{ item.rank }}</td><td>{{ item.summonerName }}</td>
                        <td v-for="(kdaItem, kdaIndex) in (item.currKDA || []).slice(0,5)" :key="kdaIndex" :class="{'kda-win': kdaItem.includes('胜'), 'kda-loss': kdaItem.includes('败')}">{{ kdaItem }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 敌方队伍 -->
            <div class="col-lg-6 table-container">
                <h3 class="h5">敌方队伍</h3>
                <button class="btn btn-danger btn-query" @click="fetchTableData(2)">查询敌方战绩</button>
                <table class="table table-hover table-bordered table-sm">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th><th scope="col">马匹</th><th scope="col">分数</th><th scope="col">段位</th><th scope="col">名字</th><th scope="col" colspan="5">最近5场战绩</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-if="tables.table2.data.length === 0"><td colspan="10" class="text-center text-muted">请点击查询按钮加载数据</td></tr>
                    <tr v-for="(item, index) in tables.table2.data" :key="index">
                        <th scope="row">{{ index + 1 }}</th><td>{{ item.horse }}</td><td>{{ item.score }}</td><td>{{ item.rank }}</td><td>{{ item.summonerName }}</td>
                        <td v-for="(kdaItem, kdaIndex) in (item.currKDA || []).slice(0,5)" :key="kdaIndex" :class="{'kda-win': kdaItem.includes('胜'), 'kda-loss': kdaItem.includes('败')}">{{ kdaItem }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <hr class="my-4">

    <!-- ======================= 召唤师战绩查询 (已修改) ======================= -->
    <section>
        <div class="section-header">
            <h2 class="h4 mb-0">召唤师信息查询</h2>
        </div>
        <!-- 搜索输入框和按钮 -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="请输入要查询的召唤师名称..." v-model="summonerSearchQuery" @keyup.enter="fetchSummonerData">
            <button class="btn btn-success" type="button" @click="fetchSummonerData" :disabled="searchResultTable.loading">
                {{ searchResultTable.loading ? '查询中...' : '搜索' }}
            </button>
        </div>

        <!-- 结果表格 (结构已修改) -->
        <div class="table-container">
            <table class="table table-hover table-bordered table-sm">
                <thead class="table-light">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">模式</th>
                    <th scope="col">胜负</th>
                    <th scope="col">英雄</th>
                    <th scope="col">kda</th>
                </tr>
                </thead>
                <tbody>
                <tr v-if="searchResultTable.loading">
                    <td colspan="4" class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        正在查询中...
                    </td>
                </tr>
                <tr v-else-if="searchResultTable.message">
                    <td colspan="4" class="text-center text-muted">{{ searchResultTable.message }}</td>
                </tr>
                <tr v-for="(item, index) in searchResultTable.data" :key="index">
                    <th scope="row">{{ index + 1 }}</th>
                    <td>{{ item.queueGame }}</td>
                    <td :class="{'kda-win': item.win === '胜', 'kda-loss': item.win === '败'}">{{ item.win }}</td>
                    <td>{{ item.championName }}</td>
                    <td>{{item.kda}}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>

<script src="./toastify-js.js"></script>
<script src="./vue.global.js"></script>
<script src="./axios.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed } = Vue;

    createApp({
        setup() {
            const API_BASE_URL = 'http://127.0.0.1:9527';

            // --- 状态管理 ---
            const config = ref({ autoAcceptGame: false, autoBanChamp: false, autoBanChampID: 0, });
            const tables = ref({ table1: { data: [] }, table2: { data: [] } });
            const heroList = ref([]);
            const searchQuery = ref('');
            const isDropdownVisible = ref(false);

            // --- 召唤师搜索状态 (已修改) ---
            const summonerSearchQuery = ref('');
            const searchResultTable = ref({
                loading: false,
                data: [],
                message: '请输入召唤师名称并点击搜索' // 初始/空状态/错误信息
            });

            const showToast = (text, isSuccess = true) => { Toastify({ text, duration: 3000, gravity: "top", position: "right", backgroundColor: isSuccess ? "#4CAF50" : "#F44336", stopOnFocus: true }).showToast(); };

            const fetchInitialConfig = async () => { /* ... 此函数不变 ... */
                try {
                    const response = await axios.get(`${API_BASE_URL}/global/config`);
                    config.value.autoAcceptGame = response.data.autoAcceptGame;
                    config.value.autoBanChamp = response.data.autoBanChamp;
                    config.value.autoBanChampID = response.data.autoBanChampID;
                    showToast('配置已从服务器同步');
                } catch (error) {
                    console.error('获取初始配置失败:', error);
                    showToast('获取初始配置失败，请检查后端服务。', false);
                }
            };

            const loadHeroData = async () => { /* ... 此函数不变 ... */
                try {
                    const response = await axios.get('./hero-data.json');
                    heroList.value = response.data;
                } catch (error) {
                    console.error('加载英雄数据失败:', error);
                    showToast('加载英雄列表失败', false);
                }
            };

            const selectedHeroDisplayName = computed(() => { /* ... 此函数不变 ... */
                if (!config.value.autoBanChampID || heroList.value.length === 0) return '';
                const selected = heroList.value.find(h => h.id === config.value.autoBanChampID);
                return selected ? `${selected.name} (${selected.nickname})` : '';
            });

            const filteredHeroes = computed(() => { /* ... 此函数不变 ... */
                if (!searchQuery.value) return heroList.value;
                const query = searchQuery.value.toLowerCase();
                return heroList.value.filter(hero =>
                    hero.name.toLowerCase().includes(query) ||
                    hero.nickname.toLowerCase().includes(query) ||
                    hero.id.toString().includes(query)
                );
            });

            const handleAutoAcceptChange = () => { /* ... 此函数不变 ... */
                const state = config.value.autoAcceptGame;
                axios.post(`${API_BASE_URL}/set/auto/accept/game`, { autoAcceptGame: state })
                    .then(() => showToast(`自动接受游戏已${state ? '开启' : '关闭'}`))
                    .catch(() => {
                        showToast('自动接受游戏状态更新失败', false);
                        config.value.autoAcceptGame = !state;
                    });
            };

            const updateBanSetting = (payload) => { /* ... 此函数不变 ... */
                axios.post(`${API_BASE_URL}/set/ban/champion`, payload,  { headers: { 'Content-Type': 'application/json' } })
                    .then(() => {
                        if (payload.autoBanChamp) {
                            const heroName = selectedHeroDisplayName.value;
                            showToast(`禁用英雄成功设置为: ${heroName}`);
                        } else {
                            showToast('已取消自动禁用英雄');
                        }
                    })
                    .catch(() => showToast("错误：设置禁用英雄失败。", false));
            };

            const selectHero = (hero) => { /* ... 此函数不变 ... */
                config.value.autoBanChampID = hero.id;
                searchQuery.value = hero.name;
                isDropdownVisible.value = false;
                updateBanSetting({ autoBanChamp: true, championId: hero.id });
            };

            const onBanSwitchChange = () => { /* ... 此函数不变 ... */
                if (!config.value.autoBanChamp) {
                    config.value.autoBanChampID = 0;
                    searchQuery.value = '';
                    updateBanSetting({ autoBanChamp: false });
                }
            };

            const hideDropdown = () => { setTimeout(() => { isDropdownVisible.value = false; }, 200); };

            const fetchTableData = (type) => { /* ... 此函数不变 ... */
                const tableKey = `table${type}`;
                const teamName = type === 1 ? '我方' : '敌方';
                tables.value[tableKey].data = [];
                axios.get(`${API_BASE_URL}/game/overview`, { params: { type } })
                    .then(response => {
                        const responseData = Array.isArray(response.data) ? response.data : (response.data.data || []);
                        if (responseData.length > 0) { tables.value[tableKey].data = responseData; showToast(`${teamName}数据加载成功！`); }
                        else { showToast(`未从服务器获取到有效${teamName}数据。`, false); }
                    })
                    .catch(() => {
                        showToast(`无法从服务器获取${teamName}数据。`, false);
                    });
            };

            // --- 重连函数 ---
            const handleReconnect = async () => { /* ... 此函数不变 ... */
                showToast('正在尝试重连...');
                try {
                    const response = await axios.post(`${API_BASE_URL}/reconnect`);
                    const isSuccess = typeof response.data === 'boolean' ? response.data : response.data.success;

                    if (isSuccess) {
                        showToast('重连成功！', true);
                    } else {
                        showToast('重连失败，请检查客户端或后端服务。', false);
                    }
                } catch (error) {
                    console.error('重连请求失败:', error);
                    showToast('重连请求失败，无法连接到后端。', false);
                }
            };

            // --- 独立查询召唤师函数 (已修改, 移除mock数据) ---
            const fetchSummonerData = async () => {
                if (!summonerSearchQuery.value.trim()) {
                    showToast('请输入要查询的召唤师名称。', false);
                    return;
                }
                searchResultTable.value.loading = true;
                searchResultTable.value.data = [];
                searchResultTable.value.message = ''; // 清除旧消息

                try {
                    const response = await axios.get(`${API_BASE_URL}/summoner/game/history`, {
                        params: { name: summonerSearchQuery.value }
                    });
                    const responseData = Array.isArray(response.data) ? response.data : (response.data.data || []);
                    if (responseData.length > 0) {
                        searchResultTable.value.data = responseData;
                        showToast('召唤师信息查询成功！');
                    } else {
                        searchResultTable.value.message = '未找到该召唤师的数据。';
                        showToast('未找到该召唤师的数据。', false);
                    }
                } catch (error) {
                    console.error('查询召唤师数据失败:', error);
                    searchResultTable.value.message = '查询失败，无法连接后端服务。';
                    showToast('查询失败，无法连接后端服务。', false);
                } finally {
                    searchResultTable.value.loading = false;
                }
            };

            onMounted(async () => {
                console.log('页面已加载，Vue 应用已挂载。');
                await Promise.all([loadHeroData(), fetchInitialConfig()]);
                if (config.value.autoBanChampID > 0) {
                    searchQuery.value = selectedHeroDisplayName.value;
                }
            });

            return {
                config, heroList, tables,
                handleAutoAcceptChange,
                searchQuery, isDropdownVisible, filteredHeroes, selectedHeroDisplayName,
                selectHero, hideDropdown, onBanSwitchChange,
                fetchTableData,
                summonerSearchQuery,
                searchResultTable,
                handleReconnect,
                fetchSummonerData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
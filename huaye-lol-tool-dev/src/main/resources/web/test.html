<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏助手配置面板</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./toastify.min.css">
    <style>
        /* CSS */
        body { background-color: #f8f9fa; padding-top: 2rem; padding-bottom: 2rem; }
        #app { max-width: 2000px; width: 90vw; margin: auto; background: #ffffff; padding: 2rem; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .section-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; }
        .form-check-label { cursor: pointer; }
        .table-container { margin-top: 1.5rem; }
        .btn-query { margin-bottom: 1rem; }
        .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
        .config-container { display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; padding: 0.5rem 0; }
        .searchable-select-container { position: relative; min-width: 220px; transition: all 0.3s ease-in-out; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; background-color: #fff; border: 1px solid #ced4da; border-radius: 0.375rem; box-shadow: 0 .5rem 1rem rgba(0,0,0,.15); list-style: none; padding: 0; margin-top: 0.25rem; }
        .search-results li { padding: 0.5rem 1rem; cursor: pointer; transition: background-color 0.2s; }
        .search-results li:hover { background-color: #e9ecef; }
        .search-results .hero-details { font-size: 0.8em; color: #6c757d; margin-left: 8px; }

        /* --- 修正后的样式 --- */
        .kda-win { background-color: rgba(0, 255, 62, 0.8) !important; color: rgba(28, 224, 72, 0.85); }
        .kda-loss { background-color: rgba(227, 17, 34, 0.89) !important; color: rgba(222, 23, 42, 0.82); }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1 class="mb-4 text-center">游戏助手配置面板</h1>

    <!-- ======================= 配置部分 (已重构) ======================= -->
    <section>
        <div class="section-header">
            <h2 class="h4 mb-0">功能配置</h2>
        </div>
        <div class="config-container">
            <!-- 开关1: 自动接受游戏 -->
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" role="switch" id="autoAcceptSwitch" v-model="config.autoAcceptGame" @change="handleAutoAcceptChange">
                <label class="form-check-label" for="autoAcceptSwitch">自动接受游戏</label>
            </div>

            <!-- 开关2: 自动禁用英雄 -->
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" role="switch" id="autoBanSwitch" v-model="config.autoBanChamp" @change="onBanSwitchChange">
                <label class="form-check-label" for="autoBanSwitch">自动禁用英雄</label>
            </div>

            <!-- 可搜索下拉框: v-if 使用 config.autoBanChamp -->
            <div class="searchable-select-container" v-if="config.autoBanChamp">
                <input
                        type="text"
                        class="form-control"
                        v-model="searchQuery"
                        :placeholder="selectedHeroDisplayName || '-- 搜索英雄名/昵称/ID --'"
                        @focus="isDropdownVisible = true"
                        @blur="hideDropdown"
                        autocomplete="off">
                <ul class="search-results" v-if="isDropdownVisible && filteredHeroes.length > 0">
                    <li v-for="hero in filteredHeroes" :key="hero.id" @mousedown="selectHero(hero)">
                        {{ hero.name }} <span class="hero-details"> ({{ hero.nickname }}, ID: {{ hero.id }})</span>
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <hr class="my-4">

    <!-- ======================= 表格部分 (已恢复) ======================= -->
    <section>
        <div class="section-header">
            <h2 class="h4 mb-0">对局详情查询</h2>
        </div>
        <div class="row g-4">
            <!-- 我方队友 -->
            <div class="col-lg-6 table-container">
                <h3 class="h5">我方队友</h3>
                <button class="btn btn-primary btn-query" @click="fetchTableData(1)">查询我方战绩</button>
                <table class="table table-hover table-bordered table-sm">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th><th scope="col">马匹</th><th scope="col">分数</th><th scope="col">段位</th><th scope="col">名字</th><th scope="col" colspan="5">最近5场战绩</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-if="tables.table1.data.length === 0"><td colspan="10" class="text-center text-muted">请点击查询按钮加载数据</td></tr>
                    <tr v-for="(item, index) in tables.table1.data" :key="index">
                        <th scope="row">{{ index + 1 }}</th><td>{{ item.horse }}</td><td>{{ item.score }}</td><td>{{ item.rank }}</td><td>{{ item.summonerName }}</td>
                        <td v-for="(kdaItem, kdaIndex) in (item.currKDA || []).slice(0,5)" :key="kdaIndex" :class="{'kda-win': kdaItem.includes('胜'), 'kda-loss': kdaItem.includes('败')}">{{ kdaItem }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 敌方队伍 -->
            <div class="col-lg-6 table-container">
                <h3 class="h5">敌方队伍</h3>
                <button class="btn btn-danger btn-query" @click="fetchTableData(2)">查询敌方战绩</button>
                <table class="table table-hover table-bordered table-sm">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">#</th><th scope="col">马匹</th><th scope="col">分数</th><th scope="col">段位</th><th scope="col">名字</th><th scope="col" colspan="5">最近5场战绩</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-if="tables.table2.data.length === 0"><td colspan="10" class="text-center text-muted">请点击查询按钮加载数据</td></tr>
                    <tr v-for="(item, index) in tables.table2.data" :key="index">
                        <th scope="row">{{ index + 1 }}</th><td>{{ item.horse }}</td><td>{{ item.score }}</td><td>{{ item.rank }}</td><td>{{ item.summonerName }}</td>
                        <td v-for="(kdaItem, kdaIndex) in (item.currKDA || []).slice(0,5)" :key="kdaIndex" :class="{'kda-win': kdaItem.includes('胜'), 'kda-loss': kdaItem.includes('败')}">{{ kdaItem }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script src="./toastify-js.js"></script>
<script src="./vue.global.js"></script>
<script src="./axios.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed } = Vue;

    createApp({
        setup() {
            const API_BASE_URL = 'http://127.0.0.1:9527';

            // --- 重构后的 config 状态，以匹配后端属性 ---
            const config = ref({
                autoAcceptGame: false,
                autoBanChamp: false,
                autoBanChampID: 0,
            });
            const tables = ref({ table1: { data: [] }, table2: { data: [] } });
            const heroList = ref([]);
            const searchQuery = ref('');
            const isDropdownVisible = ref(false);

            const showToast = (text, isSuccess = true) => { Toastify({ text, duration: 3000, gravity: "top", position: "right", backgroundColor: isSuccess ? "#4CAF50" : "#F44336", stopOnFocus: true }).showToast(); };

            // --- 从后端获取初始配置 ---
            const fetchInitialConfig = async () => {
                try {
                    const response = await axios.get(`${API_BASE_URL}/global/config`);
                    // 使用获取的数据更新本地状态
                    config.value.autoAcceptGame = response.data.autoAcceptGame;
                    config.value.autoBanChamp = response.data.autoBanChamp;
                    config.value.autoBanChampID = response.data.autoBanChampID;
                    showToast('配置已从服务器同步');
                } catch (error) {
                    console.error('获取初始配置失败:', error);
                    showToast('获取初始配置失败，请检查后端服务。', false);
                }
            };

            const loadHeroData = async () => {
                try {
                    const response = await axios.get('./hero-data.json');
                    heroList.value = response.data;
                } catch (error) {
                    console.error('加载英雄数据失败:', error);
                    showToast('加载英雄列表失败', false);
                }
            };

            // --- 计算属性，用于显示已选英雄的名称 ---
            const selectedHeroDisplayName = computed(() => {
                if (!config.value.autoBanChampID || heroList.value.length === 0) return '';
                const selected = heroList.value.find(h => h.id === config.value.autoBanChampID);
                return selected ? `${selected.name} (${selected.nickname})` : '';
            });

            const filteredHeroes = computed(() => {
                if (!searchQuery.value) return heroList.value;
                const query = searchQuery.value.toLowerCase();
                return heroList.value.filter(hero =>
                    hero.name.toLowerCase().includes(query) ||
                    hero.nickname.toLowerCase().includes(query) ||
                    hero.id.toString().includes(query)
                );
            });

            // --- “自动接受”开关的API调用 ---
            const handleAutoAcceptChange = () => {
                const state = config.value.autoAcceptGame;
                axios.post(`${API_BASE_URL}/set/auto/accept/game`, { autoAcceptGame: state })
                    .then(() => showToast(`自动接受游戏已${state ? '开启' : '关闭'}`))
                    .catch(() => {
                        showToast('自动接受游戏状态更新失败', false);
                        config.value.autoAcceptGame = !state; // 失败时回滚状态
                    });
            };

            // --- 集中处理禁用设置的更新函数 ---
            const updateBanSetting = (payload) => {
                axios.post(`${API_BASE_URL}/set/ban/champion`, payload,  {
                    headers: {
                        'Content-Type': 'application/json' // 明确告知后端这是一个JSON请求
                    }
                })
                    .then(() => {
                        if (payload.autoBanChamp) {
                            const heroName = selectedHeroDisplayName.value;
                            showToast(`禁用英雄成功设置为: ${heroName}`);
                        } else {
                            showToast('已取消自动禁用英雄');
                        }
                    })
                    .catch(() => showToast("错误：设置禁用英雄失败。", false));
            };

            // --- 从下拉框选择英雄时的逻辑 ---
            const selectHero = (hero) => {
                config.value.autoBanChampID = hero.id;
                searchQuery.value = hero.name;
                isDropdownVisible.value = false;
                // 发送“启用并设置ID”的请求
                updateBanSetting({
                    autoBanChamp: true,
                    championId: hero.id
                });
            };

            // --- “自动禁用”开关的逻辑 ---
            const onBanSwitchChange = () => {
                // 此函数在 v-model 更新 config.autoBanChamp 之后触发
                if (!config.value.autoBanChamp) { // 如果开关刚刚被关闭
                    config.value.autoBanChampID = 0;
                    searchQuery.value = '';
                    // 发送“禁用”请求
                    updateBanSetting({ autoBanChamp: false });
                }
                // 如果开关被打开，则不执行任何操作，等待用户选择英雄
            };

            const hideDropdown = () => { setTimeout(() => { isDropdownVisible.value = false; }, 200); };

            const fetchTableData = (type) => { /* 表格查询逻辑不变 */
                const tableKey = `table${type}`;
                const teamName = type === 1 ? '我方' : '敌方';
                tables.value[tableKey].data = [];
                axios.get(`${API_BASE_URL}/game/overview`, { params: { type } })
                    .then(response => {
                        const responseData = Array.isArray(response.data) ? response.data : (response.data.data || []);
                        if (responseData.length > 0) { tables.value[tableKey].data = responseData; showToast(`${teamName}数据加载成功！`); }
                        else { showToast(`未从服务器获取到有效${teamName}数据，加载模拟数据。`, false); tables.value[tableKey].data = generateMockData(type); }
                    })
                    .catch(() => {
                        showToast(`无法从服务器获取${teamName}数据，加载模拟数据。`, false);
                        tables.value[tableKey].data = generateMockData(type);
                    });
            };

            const generateMockData = (type) => { /* 模拟数据逻辑修改，以包含“胜”和“负” */
                const data = [];
                const sampleNames = { 1: ['温柔一刀', '峡谷钢琴家', '打野万花筒', '辅助的神', '我ADC贼溜'], 2: ['对面丶都是菜', '中路杀神', '野区入侵者', '脚本AD', '意识流辅助'] };
                const ranks = ['黑铁 IV', '白银 II', '黄金 I', '铂金 III', '钻石 V', '超凡大师'];
                for (let i = 0; i < 5; i++) {
                    const kdaHistory = Array.from({ length: 5 }, () => {
                        const kda = `${Math.floor(Math.random()*15)}/${Math.floor(Math.random()*10)}/${Math.floor(Math.random()*20)}`;
                        return Math.random() < 0.6 ? `${kda} 胜` : `${kda} 负`; // 60%概率为胜
                    });
                    data.push({ horse: ['上等马', '中等马', '下等马'][Math.floor(Math.random() * 3)], score: Math.floor(Math.random() * 60) + 40, rank: ranks[Math.floor(Math.random() * ranks.length)], summonerName: sampleNames[type][i], currKDA: kdaHistory });
                }
                return data;
            };

            // --- onMounted: 页面加载时加载所有必要数据 ---
            onMounted(async () => {
                console.log('页面已加载，Vue 应用已挂载。');
                // 并行加载英雄列表和初始配置
                await Promise.all([loadHeroData(), fetchInitialConfig()]);

                // 所有数据加载完毕后，同步UI
                // 如果有预选的英雄，将其名称填入搜索框
                if (config.value.autoBanChampID > 0) {
                    searchQuery.value = selectedHeroDisplayName.value;
                }
            });

            return {
                config, heroList, tables,
                handleAutoAcceptChange,
                searchQuery, isDropdownVisible, filteredHeroes, selectedHeroDisplayName,
                selectHero, hideDropdown, onBanSwitchChange,
                fetchTableData
            };
        }
    }).mount('#app');
</script>

</body>
</html>